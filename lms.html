<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eduwerks | The Three Realms</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Merriweather:ital,wght@0,300;0,700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="playlist_data.js"></script>
    
    <style>
        :root { --gold: #b08d48; --ink: #0f1115; --paper: #f4f1ea; }
        body { font-family: 'Merriweather', serif; background-color: var(--ink); color: #333; overflow-x: hidden; }
        .got-font { font-family: 'Cinzel', serif; letter-spacing: 0.1em; }
        
        /* --- DOMAIN & MAP STYLES --- */
        header { background-color: var(--paper); border-bottom: 4px solid var(--gold); }
        .domain-card { background: var(--paper); border: 1px solid #d1cfc7; color: #222; transition: 0.3s; width: 100%; max-width: 500px; }
        .domain-card:hover { transform: translateY(-8px); border-color: var(--gold); box-shadow: 0 15px 30px rgba(0,0,0,0.5); }
        
        /* --- THE SCROLLING MAP --- */
        #map-view { background-color: var(--ink); min-height: 80vh; position: relative; border-top: 1px solid #333; padding-bottom: 100px; }
        .path-line { position: absolute; left: 50%; width: 2px; background: var(--gold); height: 100%; z-index: 0; opacity: 0.3; }
        
        .level-header {
            text-align: center; margin: 60px 0 30px 0; position: relative; z-index: 10;
        }
        .level-title {
            background: var(--ink); color: var(--gold); padding: 10px 30px; border: 1px solid var(--gold);
            display: inline-block; font-family: 'Cinzel', serif; font-size: 1.2rem; letter-spacing: 0.2em;
        }

        .map-node {
            background: var(--paper); color: #111; border: 3px solid #444; width: 320px; margin: 30px auto; padding: 25px;
            text-align: center; cursor: pointer; position: relative; z-index: 10;
            clip-path: polygon(10% 0, 90% 0, 100% 15%, 100% 85%, 90% 100%, 10% 100%, 0 85%, 0 15%);
            transition: 0.3s;
        }
        .map-node:hover { transform: scale(1.05); }
        .map-node.active { border-color: var(--gold); box-shadow: 0 0 20px var(--gold); }
        .map-node.mastered { background: #e8f5e9; border-color: #2e7d32; }
        .map-node.locked { opacity: 0.4; background: #ccc; cursor: not-allowed; }

        /* --- DRAGON & PROFILE --- */
        #dragon-overlay { position: fixed; inset: 0; background: black; z-index: 99999; display: none; align-items: center; justify-content: center; flex-direction: column; }
        .dragon-sprite { font-size: 150px; color: var(--gold); position: absolute; top: 40%; left: -200px; text-shadow: 0 0 30px rgba(176,141,72, 0.8); }
        .fly-animation { animation: flyAcross 2.5s ease-in-out forwards; }
        @keyframes flyAcross { 0% { left: -200px; transform: scale(0.5) rotate(10deg); } 50% { top: 30%; transform: scale(1.2) rotate(0deg); } 100% { left: 120%; top: 20%; transform: scale(0.8) rotate(-10deg); } }
        
        #profile-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 5000; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .profile-card { background: var(--paper); border: 4px solid var(--gold); width: 400px; padding: 2rem; position: relative; box-shadow: 0 0 50px rgba(176,141,72,0.3); text-align: center; }

        /* BOT STYLES */
        #bot-bubble { position: fixed; bottom: 30px; right: 30px; width: 65px; height: 65px; background: var(--gold); border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 1000; cursor: pointer; }
        #bot-panel { position: fixed; bottom: 110px; right: 30px; width: 400px; height: 600px; background: white; border: 3px solid var(--gold); border-radius: 12px; display: none; flex-direction: column; overflow: hidden; z-index: 1000; }
    </style>
    
    <script>
        function toggleBot() { const p = document.getElementById('bot-panel'); p.style.display = (p.style.display === 'flex') ? 'none' : 'flex'; }
        function toggleProfile() { const m = document.getElementById('profile-modal'); m.style.display = (m.style.display === 'flex') ? 'none' : 'flex'; }
    </script>
</head>
<body>
    <div id="dragon-overlay">
        <i id="the-dragon" class="fas fa-dragon dragon-sprite"></i>
        <h2 class="got-font text-[#b08d48] text-4xl mt-60">ENTERING ARCHIVE...</h2>
    </div>

    <div id="profile-modal">
        <div class="profile-card">
            <button onclick="toggleProfile()" class="absolute top-4 right-4 text-gray-500 hover:text-red-500"><i class="fas fa-times"></i></button>
            <div class="w-24 h-24 mx-auto bg-black rounded-full border-2 border-[#b08d48] flex items-center justify-center mb-6"><i class="fas fa-user-graduate text-4xl text-[#b08d48]"></i></div>
            <h2 class="got-font text-2xl font-bold mb-1">MAESTER ABHIJAY</h2>
            <p class="text-xs uppercase tracking-widest text-gray-500 mb-8">Galgotias University</p>
            <div class="bg-gray-200 p-4 rounded mb-4 text-left border border-gray-300">
                <p class="text-[10px] font-bold text-gray-500 uppercase">Current Rank</p>
                <p id="profile-rank" class="got-font text-lg text-[#b08d48] font-bold">INITIATE</p>
            </div>
            <div class="bg-gray-200 p-4 rounded text-left border border-gray-300">
                <div class="flex justify-between mb-2"><p class="text-[10px] font-bold text-gray-500 uppercase">Mastery</p><p id="profile-stats" class="text-[10px] font-bold text-gray-500">0/8</p></div>
                <div class="w-full bg-gray-300 h-2 rounded-full overflow-hidden"><div id="profile-bar" class="bg-[#b08d48] h-full transition-all duration-1000" style="width: 0%"></div></div>
            </div>
        </div>
    </div>

    <header class="p-6 flex justify-between items-center shadow-xl relative z-40">
        <div class="cursor-pointer hover:opacity-80 transition-opacity" onclick="toggleProfile()">
            <h1 class="text-black got-font text-3xl">EDUWERKS <span class="text-[#b08d48]">ARCHIVES</span></h1>
            <p id="user-display" class="text-[10px] uppercase font-bold text-gray-500 flex items-center gap-2"><i class="fas fa-user-circle"></i> LOADING PROFILE...</p>
        </div>
        <button onclick="showDomains()" id="back-btn" class="hidden text-xs font-bold text-gray-800 hover:text-[#b08d48]"><i class="fas fa-compass"></i> WORLD MAP</button>
    </header>

    <main class="py-12 px-8 min-h-screen">
        <section id="domain-view" class="max-w-6xl mx-auto flex justify-center items-center h-[60vh]">
            <div onclick="enterMap('ML')" class="domain-card p-12 rounded shadow-lg group cursor-pointer text-center">
                <div class="w-20 h-20 mx-auto bg-black rounded-full flex items-center justify-center mb-6 group-hover:scale-110 transition-transform"><i class="fas fa-brain text-4xl text-[#b08d48]"></i></div>
                <h3 class="got-font text-3xl mb-4">Machine Learning</h3>
                <p class="text-sm mb-8 text-gray-600 max-w-md mx-auto">Begin your journey from Initiate to Grand Maester across 3 distinct realms of knowledge.</p>
                <button class="bg-black text-white px-8 py-3 text-sm font-bold rounded group-hover:bg-[#b08d48] transition-colors uppercase tracking-wider">Enter the Realm</button>
            </div>
        </section>

        <section id="map-view" class="hidden relative py-10 rounded-xl border border-[#222]">
            <div class="path-line"></div>
            <div id="nodes-container" class="relative z-10"></div>
        </section>
    </main>

    <div id="bot-bubble" onclick="toggleBot()"><i class="fas fa-robot text-black text-2xl"></i></div>
    <div id="bot-panel">
        <div class="bg-gray-100 p-3 border-b border-gray-300 flex justify-between items-center"><span class="got-font text-xs">MAESTER BOT</span><button onclick="toggleBot()"><i class="fas fa-times"></i></button></div>
        <iframe src="http://localhost:8501/?embed=true" width="100%" height="100%" style="border:none;"></iframe>
    </div>

    <script type="module">
        import { UserPersona, MasterConfig } from './backend_master.js';

        window.onload = () => {
            const profile = UserPersona.getProfile();
            document.getElementById('user-display').innerHTML = `<i class="fas fa-user-circle"></i> MAESTER ${profile.name} | VIEW PROFILE`;
            
            // Profile Stats
            const completed = JSON.parse(localStorage.getItem('edu_comp') || "[]");
            let total = 0;
            MasterConfig.levels.forEach(l => total += l.playlists.length);
            
            document.getElementById('profile-stats').innerText = `${completed.length}/${total}`;
            document.getElementById('profile-bar').style.width = `${(completed.length / total) * 100}%`;

            if(window.location.search.includes('view=map')) enterMap('ML');
        };

        window.showDomains = () => {
            document.getElementById('map-view').classList.add('hidden');
            document.getElementById('domain-view').classList.remove('hidden');
            document.getElementById('back-btn').classList.add('hidden');
        };

        window.enterMap = (domain) => {
            if(domain !== 'ML') return;
            document.getElementById('domain-view').classList.add('hidden');
            document.getElementById('map-view').classList.remove('hidden');
            document.getElementById('back-btn').classList.remove('hidden');

            const container = document.getElementById('nodes-container');
            const completed = JSON.parse(localStorage.getItem('edu_comp') || "[]");
            let mapHTML = "";
            let globalIndex = 0;

            // Render Levels (Beginner -> Intermediate -> Advanced)
            MasterConfig.levels.forEach(level => {
                mapHTML += `
                    <div class="level-header">
                        <span class="level-title">${level.title}</span>
                    </div>
                `;

                level.playlists.forEach(id => {
                    const mod = MasterConfig.modules[id];
                    const isMastered = completed.includes(id);
                    // Check if previous module was done OR if it's the very first one
                    const prevID = globalIndex === 0 ? null : getPrevID(globalIndex); 
                    const isUnlocked = globalIndex === 0 || (prevID && completed.includes(prevID));

                    let statusClass = isMastered ? "mastered" : (isUnlocked ? "active" : "locked");
                    let icon = isMastered ? "fa-check-circle" : (isUnlocked ? "fa-play-circle" : "fa-lock");
                    let action = isUnlocked ? `window.playDragonEntry('${id}')` : '';

                    mapHTML += `
                        <div class="map-node ${statusClass}" onclick="${action}">
                            <i class="fas ${icon} mb-2 text-xl"></i>
                            <h4 class="got-font text-sm">LEVEL ${globalIndex + 1}</h4>
                            <h3 class="font-bold text-lg">${mod.title}</h3>
                            <p class="text-[10px] italic mt-2">${mod.description}</p>
                        </div>
                    `;
                    globalIndex++;
                });
            });

            container.innerHTML = mapHTML;
        };

        function getPrevID(currentIndex) {
            // Flatten all playlists to find the previous one
            const all = [];
            MasterConfig.levels.forEach(l => all.push(...l.playlists));
            return all[currentIndex - 1];
        }

        window.playDragonEntry = (id) => {
            const overlay = document.getElementById('dragon-overlay');
            const dragon = document.getElementById('the-dragon');
            overlay.style.display = 'flex';
            dragon.classList.add('fly-animation');
            setTimeout(() => { window.location.href = `video_player.html?id=${id}`; }, 2500);
        };
    </script>
    <style>
        /* ADD THIS TO YOUR CSS */
        .bot-tabs {
            display: flex;
            background: #222;
            border-bottom: 2px solid #b08d48;
        }
        .tab-btn {
            flex: 1;
            padding: 15px;
            background: #111;
            color: gray;
            border: none;
            cursor: pointer;
            font-family: 'Cinzel', serif;
            font-size: 10px;
            transition: 0.3s;
        }
        .tab-btn:hover { background: #333; color: white; }
        .tab-btn.active {
            background: #b08d48;
            color: black;
            font-weight: bold;
        }
    </style>

    <div id="bot-bubble" onclick="toggleBot()">
        <i class="fas fa-robot text-black text-2xl"></i>
    </div>

   <div id="bot-bubble" onclick="toggleBot()">
        <i class="fas fa-robot text-black text-2xl"></i>
    </div>

    <div id="bot-panel">
        <div class="bg-gray-100 p-3 flex justify-between items-center border-b border-gray-300">
            <div class="flex items-center gap-2">
                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                <span class="got-font text-xs text-black font-bold">MAESTER SYSTEM</span>
            </div>
            <button onclick="toggleBot()"><i class="fas fa-times text-gray-500 hover:text-red-500"></i></button>
        </div>

        <div class="flex bg-[#222] border-b-2 border-[#b08d48]">
            <button id="btn-architect" class="flex-1 py-3 text-[10px] got-font text-white bg-[#b08d48] font-bold" onclick="switchBot(8501, 'btn-architect')">
                <i class="fas fa-code mr-1"></i> ARCHITECT
            </button>
            <button id="btn-scribe" class="flex-1 py-3 text-[10px] got-font text-gray-400 hover:text-white hover:bg-[#333]" onclick="switchBot(8502, 'btn-scribe')">
                <i class="fas fa-scroll mr-1"></i> SCRIBE
            </button>
        </div>

        <iframe id="bot-frame" src="http://localhost:8501/?embed=true" width="100%" height="100%" style="border:none; background: #0a0a0a;"></iframe>
    </div>

    <script>
        // GLOBAL FUNCTIONS
        function toggleBot() {
            const panel = document.getElementById('bot-panel');
            // Toggle Display
            if (panel.style.display === 'flex') {
                panel.style.display = 'none';
            } else {
                panel.style.display = 'flex';
                // Reload iframe to ensure connection if it was sleeping
                const frame = document.getElementById('bot-frame');
                if(!frame.src) frame.src = "http://localhost:8501/?embed=true";
            }
        }

        function switchBot(port, btnId) {
            // 1. Change Iframe Source
            const frame = document.getElementById('bot-frame');
            frame.src = `http://localhost:${port}/?embed=true`;

            // 2. Update Tab Styles (Visual Feedback)
            document.getElementById('btn-architect').className = "flex-1 py-3 text-[10px] got-font text-gray-400 hover:text-white hover:bg-[#333]";
            document.getElementById('btn-scribe').className = "flex-1 py-3 text-[10px] got-font text-gray-400 hover:text-white hover:bg-[#333]";
            
            // Highlight Active Button
            const activeBtn = document.getElementById(btnId);
            activeBtn.className = "flex-1 py-3 text-[10px] got-font text-white bg-[#b08d48] font-bold";
        }
    </script>

        <div class="bot-tabs">
            <button class="tab-btn active" onclick="switchBot(8501, this)">
                <i class="fas fa-code"></i> ARCHITECT
            </button>
            <button class="tab-btn" onclick="switchBot(8502, this)">
                <i class="fas fa-scroll"></i> SCRIBE
            </button>
        </div>

        <iframe id="bot-frame" src="http://localhost:8501/?embed=true" width="100%" height="100%" style="border:none;"></iframe>
    </div>

    <script>
        // GLOBAL FUNCTIONS
        function toggleBot() {
            const panel = document.getElementById('bot-panel');
            panel.style.display = (panel.style.display === 'flex') ? 'none' : 'flex';
        }

        function switchBot(port, btn) {
            // 1. Change Iframe Source
            const frame = document.getElementById('bot-frame');
            frame.src = `http://localhost:${port}/?embed=true`;

            // 2. Update Tab Styles
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
    </script>
    <div class="flex bg-[#222] border-b-2 border-[#b08d48]">
    
    <button id="btn-architect" class="flex-1 py-3 text-[10px] got-font text-white bg-[#b08d48] font-bold transition-all" onclick="switchBot(8501, 'btn-architect')">
        <i class="fas fa-robot text-lg mb-1 block"></i> ARCHITECT
    </button>
    
    <button id="btn-scribe" class="flex-1 py-3 text-[10px] got-font text-gray-400 hover:text-white hover:bg-[#333] transition-all" onclick="switchBot(8502, 'btn-scribe')">
        <i class="fas fa-scroll text-lg mb-1 block"></i> SCRIBE
    </button>
    <div id="bot-bubble" onclick="toggleBot()">
        <i class="fas fa-robot text-black text-2xl"></i>
    </div>

    <div id="bot-panel">
        <div class="bg-gray-100 p-3 flex justify-between items-center border-b border-gray-300">
            <div class="flex items-center gap-2">
                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                <span class="got-font text-xs text-black font-bold">MAESTER SYSTEM</span>
            </div>
            <button onclick="toggleBot()"><i class="fas fa-times text-gray-500 hover:text-red-500"></i></button>
        </div>

        <div class="flex bg-[#222] border-b-2 border-[#b08d48]">
            <button id="btn-architect" class="flex-1 py-3 text-[10px] got-font text-white bg-[#b08d48] font-bold transition-all" onclick="switchBot(8501, 'btn-architect')">
                <i class="fas fa-robot mr-1"></i> ARCHITECT
            </button>
            <button id="btn-scribe" class="flex-1 py-3 text-[10px] got-font text-gray-400 hover:text-white hover:bg-[#333] transition-all" onclick="switchBot(8502, 'btn-scribe')">
                <i class="fas fa-scroll mr-1"></i> SCRIBE
            </button>
        </div>

        <iframe id="bot-frame" src="http://127.0.0.1:8501/?embed=true" width="100%" height="100%" style="border:none; background: #0a0a0a;"></iframe>
    </div>

    <script>
        function toggleBot() {
            const panel = document.getElementById('bot-panel');
            if (panel.style.display === 'flex') {
                panel.style.display = 'none';
            } else {
                panel.style.display = 'flex';
                // Force reload if empty
                const frame = document.getElementById('bot-frame');
                if(!frame.src || frame.src === "") {
                    frame.src = "http://127.0.0.1:8501/?embed=true";
                }
            }
        }

        function switchBot(port, btnId) {
            const frame = document.getElementById('bot-frame');
            // Using 127.0.0.1 is often more reliable for iframes than localhost
            frame.src = `http://127.0.0.1:${port}/?embed=true`;

            // Reset Tabs
            document.getElementById('btn-architect').className = "flex-1 py-3 text-[10px] got-font text-gray-400 hover:text-white hover:bg-[#333]";
            document.getElementById('btn-scribe').className = "flex-1 py-3 text-[10px] got-font text-gray-400 hover:text-white hover:bg-[#333]";
            
            // Set Active
            document.getElementById(btnId).className = "flex-1 py-3 text-[10px] got-font text-white bg-[#b08d48] font-bold";
        }
    </script>
</div>
</body>
</html>